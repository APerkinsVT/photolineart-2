# PhotoLineArt Workplan — 2025-12-26

This plan updates the previous roadmap to align with the current codebase (Vite + React Router) and your stated intent.

## Phase 1 — Supabase + backend gate (pre-Replicate)

### Supabase schema
We will **not** modify `users` yet. We will add:
- `segment` column on `public.email_captures`.
- New `public.credits` table keyed by email.

SQL to run:
```sql
alter table public.email_captures
add column segment text;

create table public.credits (
  id uuid not null default gen_random_uuid(),
  email text not null unique,
  free_used_at timestamp with time zone,
  credits_remaining integer not null default 0,
  total_purchased integer not null default 0,
  last_purchase_at timestamp with time zone,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  constraint credits_pkey primary key (id)
);
```

### Backend helper
Add a helper, e.g. `getOrCreateCreditsByEmail(email: string)`:
- Normalize email (lowercase, trim).
- Fetch row from `credits` by email.
- If missing, insert defaults.
- Return `{ email, free_used_at, credits_remaining }`.

### Gate in the existing generate route
Current single-page generation is handled by `api/ai-lineart.ts` (Replicate + tips).

Update `api/ai-lineart.ts` to:
- Require `email` in the request body.
- Call `getOrCreateCreditsByEmail(email)`.
- Apply gate logic **before** Replicate:
  - If `free_used_at` is null → allow as `"free"`.
  - Else if `credits_remaining > 0` → allow as `"credit"` and decrement by 1.
  - Else → return `{ status: "no_credits" }` and do not run AI.

On success:
- If free: set `free_used_at = now()`.
- If credit: decrement `credits_remaining` and persist.

On failure:
- Do **not** consume free/credits. Only update on successful AI response.

Response shape (extends current response):
```ts
{
  status: "ok" | "no_credits";
  generationType?: "free" | "credit";
  creditsRemaining?: number;
  lineArtUrl?: string;
  analysis?: LineArtAnalysis;
}
```

### Stripe credits webhook stub
Add `/api/stripe/webhook` (or similar):
- Verify Stripe signature.
- On checkout complete for 3-for-$5 pack, increment credits by 3.
- If product IDs not ready, stub with TODO comments.

## Phase 2 — Frontend integration (LandingPage)

### Email requirement
The Landing page currently requests email after generation. We will move email collection to **before** the generate call so the backend gate can run.

If email missing or invalid:
- Show a friendly inline error.
- Prevent the AI call.

### Handle gate responses
Update the Landing page flow that calls `/api/ai-lineart`:
- `status: "ok"` → render results.
- `generationType: "credit"` → show “You have X credits remaining.”
- `status: "no_credits"` → open the 3-for-$5 credits upsell modal.

### Credits upsell modal
Add a small modal component:
- Title + short copy about the 3-for-$5 pack.
- Primary CTA starts Stripe Checkout for credits pack.
- Secondary “Maybe later” closes modal.

On successful Stripe return:
- Refresh credits state.
- Show “Credits added” confirmation.

### Book upsell modal removal
Remove the **book upsell modal** from the Landing page. The book offer remains only in Studio.

## Phase 3 — Landing Page “Who uses PhotoLineArt?” section

Add a new section with `id="who-uses"` containing 4 segment cards with anchor IDs:
- `families`
- `couples`
- `pets`
- `places`

Each card includes:
- Heading
- 2–3 lines of copy
- 1–2 example images (placeholder paths ok for now)
- CTA button linking to the **Landing** upload module (not Studio), optionally with `?seg=...`.

### Hash anchor support
Support deep-links like `/#families`, `/#pets`, etc.
- On page load, scroll into view if `window.location.hash` matches a card ID.

### Segment capture
If `?seg=` is present, store it with `email_captures.segment` when submitting email.

## Phase 4 — Copy + UX polish

### Hero copy update
Update hero copy to reflect pricing:
- “Turn your favorite photos into printable coloring pages.”
- “Your first page is free — extra pages are 3 for $5.”

### Result messaging
On results view:
- If generationType === "free": nudge the 3-for-$5 pack.
- If creditsRemaining > 0: show “You have X pages remaining.”

### Error states
Ensure errors are user-friendly and do not consume credits.

## Order of work
1) Phase 1 – backend gate + schema SQL.
2) Phase 2 – Landing page integration + credits modal.
3) Phase 3 – “Who uses” section + anchors.
4) Phase 4 – copy polish.
