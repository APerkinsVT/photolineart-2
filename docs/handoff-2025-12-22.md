# PhotoLineArt Handoff — 2025-12-22

## Status summary
- App is live on Vercel and working for:
  - Free single-photo flow on Landing page: upload → line art/palette/tips → email capture → PDF download/email.
  - Paid multi-photo (Studio) flow: Stripe checkout → upload up to 6 photos (temporarily 10 for personal use) → processing → email book → logging in Supabase.
- Meta Pixel + GA are installed and firing custom events (see Events section).
- Supabase logging is in place for `email_captures`, `runs`, and `downloads` (downloads table added recently).
- Stripe Checkout works in test and live. Current offer: **6 photos for $19** (hybrid modal on Landing Page).
- Portal page exists but is no longer intended as the main user destination; direct PDF download links are used (with QR/text links inside PDF depending on retention path).

## Key flows

### Free single-photo (Landing Page)
1. User uploads one photo.
2. AI generates line art + palette + tips; preview appears on the page.
3. User clicks download/email CTA (email required at that point).
4. PDF is generated and offered for download and emailed.
5. Files are deleted after send (free flow).
6. Logging:
   - `email_captures` in Supabase.
   - Meta/GA events for key button clicks.

### Paid book (Studio Page)
1. User arrives at Studio. If not paid, sees Stripe CTA (email + “Continue to payment”).
2. Stripe Checkout → success returns to Studio with `?paid=1`.
3. Upload console appears; user selects photos (6 max, temporarily 10 for dev).
4. Titles can be edited per photo (used in PDF/manifest).
5. Click “Start processing” → line art generation + tips.
6. After processing, retention choice appears (required):
   - **Delete after send** → email with PDF attachment only; no portal link or QR in PDF.
   - **Keep 30 days** → PDF stored in blob, email includes download link; PDF includes QR + text link.
7. Logging:
   - `runs` table in Supabase with `pla_run_id`, `pdf_url` (for keep 30 days), etc.

## Important decisions / UX
- Hybrid offer on Landing: “Download your free page” → modal with paid or free choice. Email is captured in the modal.
- Paid offer is **6 photos for $19**. All copy updated to “6 photos”.
- Studio page is paywalled until Stripe success. Upload UI is hidden until paid.
- Portal page is retained but de-emphasized; direct PDF download links are used instead.
- Retention choice is required before sending book email; UI hides options when not applicable.

## Meta + GA events (current)
Landing page:
- `PageView_Landing` (Meta custom)
- `LP_ChooseFile`
- `LP_GetLineArt` / `LP_CreateFreePage`
- `LP_OfferModalOpen`
- `LP_CheckoutStart` (offer: book6)
- `LP_DownloadClick`
- `LP_SeeBooks`
- `LP_DownloadCTA`
- GA rating event: `rating_submit`

Studio page:
- `PageView_Studio`
- `SP_CheckoutStart`
- `SP_ChoosePhotos`
- `SP_StartProcessing`
- `SP_EmailBook`
- `SP_SeeBooks`

Meta optimization:
- Custom conversion created for `SP_EmailBook` (Purchase). A separate conversion for `LP_DownloadClick` can be used for higher-volume optimization.

## Stripe
- Stripe Checkout integration via `api/create-checkout-session.ts`.
- Env vars (new naming):
  - `STRIPE_SECRET_TEST_KEY`
  - `STRIPE_SECRET_LIVE_KEY`
  - `STRIPE_PRICE_ID_6_BOOK_TEST`
  - `STRIPE_PRICE_ID_6_BOOK_LIVE`
  - (publishable keys not used yet)
- Hybrid modal uses Stripe Checkout for paid path, free path uses existing email+download flow.

## Supabase
- Tables in use:
  - `public.email_captures` (email, opt_in, rating, source, created_at)
  - `public.runs` (book runs, includes `pla_run_id` column)
  - `public.downloads` (added for tracking download events)
- Supabase env vars:
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`
- Logging happens server-side (API routes).

## Key files (high impact)
- `src/routes/LandingPage.tsx` — free flow, offer modal, email capture, CTA tracking, star rating.
- `src/routes/StudioPage.tsx` — paid gate, upload console, retention choice, processing, email sending.
- `src/components/UploadDropzone.tsx` — max photo limit constant.
- `src/state/useBatchUploader.ts` — upload pipeline.
- `api/create-checkout-session.ts` — Stripe checkout session.
- `api/send-pdf.ts` — email sending (single + book) and Supabase email capture logging.
- `api/log-run.ts` — Supabase run logging for book flow.
- `api/upload-pdf.ts` — stores PDF in blob (keep-30-days path).
- `src/print/pdfBuilder.ts` + `src/print/*` — PDF generation for single + book.
- `src/styles/photolineart.css` — main site styles (no Tailwind in use).
- `index.html` — GA + Meta Pixel snippet.

## Recent fixes / gotchas
- Vercel builds must deploy correct commit; previous errors were due to wrong deploy SHA.
- Stripe response typing fix in `api/create-checkout-session.ts`:
  - `const stripeData = (await stripeResp.json()) as any;`
- `pla_run_id` added to `runs` table to store client run ID (different from Supabase row ID).
- QR/text links in PDFs must be wrapped so long URLs don’t run off page.
- On Studio, ensure retention selection is required and `Email my book` is disabled without it.

## Current temporary personal tweak
- For personal use only: max photos set to **10** by editing:
  - `src/components/UploadDropzone.tsx` → `const maxPhotos = 10;`
  - `src/routes/StudioPage.tsx` → `const MAX_BOOK_PHOTOS = 10;`
  - Copy still says 6 (intentionally for dev only).

## Pending / open items
- Copy polish for paid flow (Landing + Studio) before full live launch.
- Add Contact page form logging to Supabase (table created; need to verify wiring).
- GA on Studio page was requested but not yet wired (verify).
- Consider optimizing image size for PDF generation (downsized assets for large mobile uploads).
- Clean up long-term: remove unused portal features or re-style Portal page if retained.

## Testing checklist (dev and live)
Free flow:
- Upload → line art renders → download + email → Supabase email capture entry.
Paid flow:
- Stripe checkout → return to Studio paid flow → upload & process → retention choice → email + PDF delivery → Supabase runs log entry.
Meta/GA:
- Verify `SP_EmailBook` and `LP_DownloadClick` in Events Manager.

## Environment / servers
- Dev uses two terminals:
  - Terminal A: `npx vercel dev --listen 3001`
  - Terminal B: `npm run dev` (Vite)
- Live deploy via GitHub → Vercel.

## Notes on portal usage
- Portal is retained but not used in primary UX. Direct PDF link is preferred.
- For delete-after-send path: no portal link in email/PDF.
- For keep-30-days path: PDF stored in blob, QR + text link in PDF; email contains direct download link.

